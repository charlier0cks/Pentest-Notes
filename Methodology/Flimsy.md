202307101421
Status: #apt-get #apt #cron #cronjob #apisix #api 
Tags: [[Labs]] [[pg]]

# Flimsy
IP: 192.168.167.220

## Recon

Ports open:

```
22/tcp    open   ssh
80/tcp    open   http
3306/tcp  open   mysql
8080/tcp  closed http-proxy
43500/tcp open   unknown
```

- I was trying to spider through the website but could not find anything useful.
- Looking back at my nmap scan, I was able to see the http-server-header: `APISIX/2.8` for port 43500.
- Some googling revealed that this API was vulnerable to `CVE-2022-24112 - Remote Code Execution`

## Exploitation

- The exploit was pretty straight forward:

![[flimsy_exp.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/flimsy_exp.png">

## Escalate Privileges

- After some manual enumeration, we discovered two cronjobs in the crontabs file being executed by root.

```bash
* * * * * root apt-get update
* * * * * root /root/run.sh
```

- Apt update is a cronjob which can be leveraged to escalate privileges.
- If we have write permissions in the /etc/apt/apt.conf.d directory, then we can create a script and place it in there.
- The naming conventions for the script must start with two digits, preferably 00. Apt will execute the script starting with 00 first within the directory before updating.
- This is our script, a little dirty, but will do:

```bash
#!/bin/bash

chmod u+s /bin/bash
```

- Now we name it 00privesc and place it in the directory we specified.
- Now we wait for root to execute the cronjob and we should see that the bash binary now has a SUID bit set.
- We can now get a root shell:

```bash
bash -p
```

- root!








---
# References

Apache-APISIX-CVE-2022-24112: https://github.com/M4xSec/Apache-APISIX-CVE-2022-24112